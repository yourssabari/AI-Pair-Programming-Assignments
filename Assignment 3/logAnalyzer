import re
from collections import Counter
import csv

log_file = 'secure-20250817'
csv_file = 'ip_request_counts.csv'

# Regex to match IPv4 addresses
ip_regex = re.compile(r'\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b')

# Read log and count IPs
with open(log_file, 'r') as f:
    ips = []
    for line in f:
        match = ip_regex.search(line)
        if match:
            ips.append(match.group())

ip_counts = Counter(ips)

# Get top 5 IPs
top_5 = ip_counts.most_common(5)

# Write all IP counts to CSV (at least 20 lines)
with open(csv_file, 'w', newline='') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(['IP Address', 'Request Count'])
    for ip, count in ip_counts.most_common(20):
        writer.writerow([ip, count])

print("Top 5 IPs by request count:")
for ip, count in top_5:
    print(f"{ip}: {count} requests")
print(f"Results saved to {csv_file}")